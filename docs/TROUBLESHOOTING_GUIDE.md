# AI reStarter トラブルシューティングガイド

## 目次
1. [一般的な問題](#一般的な問題)
2. [画面キャプチャの問題](#画面キャプチャの問題)
3. [テンプレートマッチングの問題](#テンプレートマッチングの問題)
4. [復旧アクションの問題](#復旧アクションの問題)
5. [パフォーマンスの問題](#パフォーマンスの問題)
6. [設定の問題](#設定の問題)
7. [ログ分析](#ログ分析)
8. [高度なトラブルシューティング](#高度なトラブルシューティング)

## 一般的な問題

### アプリケーションが起動しない

#### 症状
- `python main.py`を実行してもウィンドウが表示されない
- エラーメッセージが表示される

#### 原因と解決方法

**1. Python環境の問題**
```bash
# Python バージョン確認
python --version
# 3.11以上であることを確認

# 仮想環境の確認
where python
# venv\Scripts\python.exe が表示されることを確認
```

**2. 依存関係の問題**
```bash
# 依存関係の再インストール
venv\Scripts\activate
pip install -e ".[dev]" --force-reinstall
```

**3. tkinterの問題（Windows Store版Python）**
```bash
# 公式Python.orgからPythonを再インストール
# Windows Store版は使用しない
```

### ホットキーが動作しない

#### 症状
- `Ctrl+Alt+S`などのホットキーが反応しない

#### 解決方法

**1. 権限の確認**
```bash
# 管理者権限で実行しない（通常権限で実行）
python main.py
```

**2. 他のアプリケーションとの競合**
- 他のアプリケーションが同じホットキーを使用していないか確認
- 一時的に他のアプリケーションを終了して確認

**3. キーボードフックの再初期化**
- アプリケーションを再起動
- ログで「ホットキー設定完了」メッセージを確認

## 画面キャプチャの問題

### 画面キャプチャが真っ黒になる

#### 症状
- 監視画面が真っ黒で何も表示されない
- テンプレートマッチングが全く動作しない

#### 原因
- マルチモニター環境での座標問題
- 負の座標値の設定
- ディスプレイスケーリングの問題

#### 解決方法

**1. ディスプレイ設定の確認**
```
Windowsの設定 → システム → ディスプレイ
- メインディスプレイを左側に配置
- スケーリングを100%に設定（推奨）
```

**2. AI-IDEの配置**
- AI-IDEをメインディスプレイに移動
- ウィンドウを最大化しない（通常サイズで使用）

**3. 監視エリアの再設定**
```
メインウィンドウ → 設定 → 監視エリア設定
- 座標が正の値であることを確認
- 幅と高さが適切であることを確認
```

**4. 設定ファイルの手動修正**
```json
// kiro_config.json
{
  "monitor_region": [100, 100, 800, 600]  // [x, y, width, height]
}
```

### 画面キャプチャが部分的におかしい

#### 症状
- 一部の領域だけが正しくキャプチャされない
- 色が変わって表示される

#### 解決方法

**1. ディスプレイドライバーの更新**
- 最新のグラフィックドライバーをインストール

**2. 色深度の確認**
```
ディスプレイ設定 → 詳細なディスプレイ設定
- 色深度を32ビットに設定
```

**3. ハードウェアアクセラレーションの無効化**
- AI-IDEのハードウェアアクセラレーションを無効化

## テンプレートマッチングの問題

### テンプレートが検出されない

#### 症状
- エラー画面が表示されているのに検出されない
- ログに「マッチング結果: 0.XX」と低い値が表示される

#### 原因と解決方法

**1. テンプレートの品質問題**
```
対処法:
- より特徴的な部分を選択してテンプレート作成
- 文字部分よりもアイコンや色の境界を選択
- 小さすぎる領域は避ける（最小50x50ピクセル推奨）
```

**2. 閾値の調整**
```json
// kiro_config.json
{
  "template_threshold": 0.7  // 0.8から0.7に下げる
}
```

**3. 画面解像度の変更**
- テンプレート作成時と現在の解像度が異なる場合
- 同じ解像度でテンプレートを再作成

**4. ディスプレイスケーリング**
```
Windowsの設定 → ディスプレイ → 拡大縮小とレイアウト
- 100%に設定（推奨）
- テンプレート作成時と同じスケーリングを使用
```

### 誤検出が多い

#### 症状
- エラーでない画面でも検出される
- 頻繁に誤った復旧アクションが実行される

#### 解決方法

**1. 閾値の調整**
```json
{
  "template_threshold": 0.9  // より厳密に
}
```

**2. テンプレートの改善**
- より特徴的で一意な部分を選択
- 複数のテンプレートで組み合わせ検証

**3. 監視エリアの限定**
- エラー表示エリアのみに監視範囲を限定

## 復旧アクションの問題

### 復旧アクションが実行されない

#### 症状
- エラーを検出したが復旧アクションが動作しない
- ログに「復旧アクション実行」が表示されない

#### 原因と解決方法

**1. 座標設定の問題**
```json
// kiro_config.json - チャット入力欄の座標を確認
{
  "chat_input_position": [1457, 932]  // 正確な座標に修正
}
```

**2. ウィンドウの状態**
- AI-IDEウィンドウが前面にあることを確認
- 他のウィンドウに隠れていないか確認
- 最小化されていないか確認

**3. タイミングの問題**
```json
{
  "action_delay": 1.0  // 0.5から1.0に増加
}
```

### AmazonQの実行ボタンがクリックされない

#### 症状
- ▶RUNボタンを検出したがクリックされない

#### 解決方法

**1. テンプレートの確認**
```
amazonq_templates/run_button.png を確認
- 現在の▶RUNボタンと一致しているか
- 必要に応じて再作成
```

**2. クリック座標の調整**
- ボタンの中央をクリックしているか確認
- ボタンサイズの変更に対応

**3. 待機時間の調整**
```json
{
  "amazonq_detector": {
    "click_delay": 0.5  // クリック前の待機時間
  }
}
```

## パフォーマンスの問題

### CPU使用率が高い

#### 症状
- AI reStarterのCPU使用率が常に高い
- システム全体が重くなる

#### 解決方法

**1. 監視間隔の調整**
```json
{
  "monitor_interval": 3.0  // 2.0から3.0に増加
}
```

**2. 監視エリアの縮小**
- 必要最小限の領域のみを監視
- 全画面監視は避ける

**3. テンプレート数の削減**
- 使用頻度の低いテンプレートを削除
- 類似テンプレートを統合

### メモリ使用量が増加し続ける

#### 症状
- 長時間実行するとメモリ使用量が増加
- 最終的にシステムが不安定になる

#### 解決方法

**1. 定期的な再起動**
```bash
# 8時間ごとにアプリケーションを再起動（推奨）
```

**2. 画像キャッシュの無効化**
```json
{
  "image_cache_enabled": false
}
```

**3. ガベージコレクションの強制実行**
- 長時間実行時は手動でアプリケーション再起動

## 設定の問題

### 設定ファイルが読み込まれない

#### 症状
- 設定を変更しても反映されない
- デフォルト値が使用され続ける

#### 解決方法

**1. ファイルパスの確認**
```bash
# 設定ファイルの存在確認
dir kiro_config.json
```

**2. JSON形式の確認**
```bash
# JSON形式の検証
python -c "import json; print(json.load(open('kiro_config.json')))"
```

**3. 権限の確認**
- ファイルの読み書き権限を確認
- 必要に応じて権限を修正

### 設定が保存されない

#### 症状
- GUI で設定を変更しても次回起動時に戻る

#### 解決方法

**1. ファイル権限の確認**
```bash
# ファイルの属性確認
attrib kiro_config.json
# 読み取り専用でないことを確認
```

**2. ディスク容量の確認**
- 十分な空き容量があることを確認

**3. ウイルス対策ソフトの確認**
- ファイル保護機能が干渉していないか確認

## ログ分析

### 重要なログメッセージ

#### 正常動作のログ
```
INFO - 画面キャプチャを実行しました
INFO - テンプレートマッチング結果: 0.85
INFO - 復旧アクションを実行しました
```

#### 問題を示すログ
```
ERROR - 画面キャプチャに失敗しました
WARNING - テンプレートマッチング結果が低い: 0.3
ERROR - 復旧アクション実行に失敗しました
```

### ログレベルの調整

**デバッグ情報を増やす場合**
```json
{
  "log_level": "DEBUG"
}
```

**ログを軽量化する場合**
```json
{
  "log_level": "WARNING"
}
```

### ログファイルの管理

**ログファイルのローテーション**
```bash
# 古いログファイルのバックアップ
copy ai_restarter.log ai_restarter_backup.log
echo. > ai_restarter.log
```

## 高度なトラブルシューティング

### デバッグモードでの実行

```bash
# デバッグ情報付きで実行
venv\Scripts\activate
python -c "
import logging
logging.basicConfig(level=logging.DEBUG)
exec(open('main.py').read())
"
```

### 設定ファイルのリセット

```bash
# 設定ファイルのバックアップ
copy kiro_config.json kiro_config_backup.json

# デフォルト設定で再作成
del kiro_config.json
python main.py
```

### テンプレートファイルの検証

```python
# テンプレート画像の確認スクリプト
import cv2
import os

template_dir = "error_templates"
for filename in os.listdir(template_dir):
    if filename.endswith('.png'):
        img = cv2.imread(os.path.join(template_dir, filename))
        if img is not None:
            print(f"{filename}: {img.shape}")
        else:
            print(f"{filename}: 読み込み失敗")
```

### システム情報の収集

```bash
# システム情報の収集（サポート用）
venv\Scripts\activate
python -c "
import sys
import platform
import cv2
import numpy as np
print(f'Python: {sys.version}')
print(f'Platform: {platform.platform()}')
print(f'OpenCV: {cv2.__version__}')
print(f'NumPy: {np.__version__}')
"
```

## サポートへの問題報告

### 報告時に含める情報

1. **エラーの詳細**
   - 具体的な症状
   - 再現手順
   - 発生頻度

2. **環境情報**
   - OS バージョン
   - Python バージョン
   - ディスプレイ設定

3. **ログファイル**
   - `ai_restarter.log`
   - `kiro_recovery.log`

4. **設定ファイル**
   - `kiro_config.json`（機密情報は削除）

5. **スクリーンショット**
   - エラー画面
   - 設定画面

### 問題報告のテンプレート

```
## 問題の概要
[問題の簡潔な説明]

## 再現手順
1. [手順1]
2. [手順2]
3. [手順3]

## 期待される動作
[期待していた動作]

## 実際の動作
[実際に起こった動作]

## 環境情報
- OS: Windows 10/11
- Python: [バージョン]
- AI reStarter: [バージョン]

## ログ情報
[関連するログメッセージ]

## 追加情報
[その他の関連情報]
```

---

このガイドで解決しない問題については、GitHubのIssuesページで報告してください。
